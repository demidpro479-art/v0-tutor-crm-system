# Руководство по системе управления репетиторским центром

## Обзор системы

Полноценная CRM система для управления репетиторским центром с четырьмя уровнями доступа:
- **Главный Администратор (ГА)** - полный контроль над системой
- **Репетиторы** - управление своими учениками и уроками
- **Менеджеры** - управление платежами и клиентами
- **Ученики** - личный кабинет с расписанием и заданиями

## Роли и функционал

### 1. Главный Администратор (admin)

**Доступ:** `/admin`

**Функционал:**
- ✅ Управление всеми пользователями (добавление, редактирование, удаление)
- ✅ Просмотр всех учеников в виде таблицы
- ✅ Просмотр учеников по репетиторам (папки с репетиторами)
- ✅ Управление выплатами зарплат (одобрение/отклонение)
- ✅ Отмена начислений за уроки
- ✅ Установка ставок для репетиторов (сколько получают за урок)
- ✅ Установка стоимости уроков
- ✅ Аналитика за месяц (общий доход, чистая прибыль, проведенные уроки)
- ✅ Все функции репетитора (может быть репетитором)

**Статистика:**
- Общий доход (грязный) - все деньги от клиентов
- Чистая прибыль - доход минус зарплаты репетиторов и менеджеров
- Проведено уроков за месяц
- Всего пользователей в системе

**Управление выплатами:**
- Просмотр всех запросов на выплату зарплаты
- Одобрение выплаты (статус "paid")
- Отклонение выплаты с указанием причины (статус "rejected")
- При отклонении сумма обнуляется

### 2. Репетиторы (tutor)

**Доступ:** `/tutor`

**Функционал:**
- ✅ Добавление своих учеников
- ✅ Управление расписанием уроков
- ✅ Создание регулярных расписаний
- ✅ Отметка уроков как проведенных
- ✅ Выставление оценок за уроки
- ✅ Прикрепление домашних заданий
- ✅ Просмотр своего заработка
- ✅ История выплат (заработано, выплачено, в ожидании, отклонено)

**Заработок:**
- За каждый проведенный урок (статус "completed") автоматически начисляется сумма
- Сумма устанавливается ГА в настройках репетитора
- Заработок за неделю суммируется
- Раз в неделю создается запрос на выплату
- Репетитор видит: заработано, выплачено, в ожидании, отклонено, баланс

**Статистика:**
- Всего учеников
- Проведено уроков
- Заработано всего
- Предстоящих уроков

### 3. Менеджеры (manager)

**Доступ:** `/manager`

**Функционал:**
- ✅ Добавление платежей от клиентов
- ✅ Прикрепление чеков к платежам
- ✅ Добавление уроков ученикам
- ✅ Просмотр всех учеников
- ✅ Просмотр своего заработка

**Заработок:**
- Фиксированная ставка: 500₽ в неделю
- Комиссия: 5% от всех продаж за неделю
- Формула: `ЗП = 500₽ + (Продажи × 0.05)`
- Выплаты раз в неделю

**Статистика:**
- Продажи за неделю
- Заработок за неделю
- Всего учеников
- Ожидают оплаты

### 4. Ученики (student)

**Доступ:** `/student`

**Функционал:**
- ✅ Просмотр своего расписания
- ✅ Просмотр оставшихся уроков
- ✅ Просмотр оценок за уроки
- ✅ Просмотр домашних заданий
- ✅ Ссылка на урок (Zoom, Google Meet и т.д.)
- ✅ Информация о своем преподавателе
- ✅ Установка никнейма при первом входе
- ✅ Графики и статистика

**Особенности:**
- Время отображается в фактическом формате (пермское - 2 часа)
- Никнейм виден только ученику
- Ссылка на урок одна и та же для всех уроков
- Показывается имя преподавателя

## Система выплат

### Создание выплат

**Автоматически:**
- Каждую неделю система создает записи в таблице `salary_payments`
- Для репетиторов: сумма = заработок за неделю
- Для менеджеров: сумма = 500₽ + 5% от продаж

**Статусы выплат:**
- `pending` - ожидает одобрения ГА
- `paid` - выплачено
- `rejected` - отклонено

### Обработка выплат (ГА)

1. **Одобрение выплаты:**
   - Статус меняется на `paid`
   - Сумма добавляется в `paid_amount`
   - Создается запись в истории транзакций

2. **Отклонение выплаты:**
   - Статус меняется на `rejected`
   - Указывается причина отклонения
   - Сумма обнуляется в `pending_amount`
   - Создается запись в истории транзакций

### Отмена начисления за урок

ГА может отменить начисление за конкретный урок:
- Уменьшается заработок репетитора
- Создается запись в истории транзакций
- Указывается причина отмены

## Система учеников

### Создание ученика

**Кто может создавать:**
- ГА - может назначить любого репетитора
- Репетитор - ученик автоматически привязывается к нему
- Менеджер - может назначить репетитора

**Обязательные поля:**
- Имя ученика
- Репетитор (для ГА и менеджера)
- Ссылка на урок (опционально)

**Создание аккаунта:**
- Можно создать аккаунт для входа ученика
- Генерируется логин и пароль
- Ученик может войти в систему

### Привязка к репетитору

- Каждый ученик привязан к одному репетитору
- Репетитор видит только своих учеников
- ГА видит всех учеников
- Менеджер видит всех учеников

### Ссылка на урок

- Одна ссылка для всех уроков ученика
- Указывается при создании ученика
- Можно изменить в деталях ученика
- Отображается ученику в расписании

## Система уроков

### Создание уроков

**Способы создания:**
1. Вручную - добавление разового урока
2. Регулярное расписание - автоматическое создание уроков

### Регулярное расписание

**Создание:**
- Выбор дней недели
- Указание времени
- Автоматическое создание уроков на месяц вперед

**Редактирование:**
- Изменение времени
- Все будущие уроки автоматически обновляются
- Старые уроки удаляются, создаются новые

**Удаление:**
- Удаление расписания
- Все будущие уроки удаляются

### Статусы уроков

- `scheduled` - запланирован
- `completed` - проведен (списывается урок, начисляется заработок)
- `cancelled` - отменен
- `missed` - пропущен

### Оценки и ДЗ

**Репетитор может:**
- Выставить оценку от 1 до 5
- Прикрепить домашнее задание
- Добавить заметки к уроку

**Ученик видит:**
- Оценки за все уроки
- Домашние задания
- График оценок

## Время в системе

### Для репетиторов и ГА
- Время вводится как есть (например, 16:00)
- Сохраняется в БД с учетом часового пояса

### Для учеников
- Отображается фактическое время (пермское - 2 часа)
- Если репетитор ввел 16:00, ученик видит 14:00
- Это настраивается в компоненте `student-dashboard.tsx`

## База данных

### Основные таблицы

**profiles** - пользователи системы
- `id` - UUID
- `email` - email
- `full_name` - полное имя
- `role` - роль (admin, tutor, manager, student)
- `avatar_url` - аватар

**students** - ученики
- `id` - UUID
- `name` - имя
- `tutor_id` - ID репетитора
- `total_paid_lessons` - всего оплачено уроков
- `remaining_lessons` - осталось уроков
- `lesson_link` - ссылка на урок
- `auth_user_id` - ID пользователя для входа

**lessons** - уроки
- `id` - UUID
- `student_id` - ID ученика
- `scheduled_at` - дата и время
- `status` - статус
- `grade` - оценка
- `homework` - домашнее задание
- `lesson_link` - ссылка на урок

**earnings** - заработок репетиторов
- `user_id` - ID репетитора
- `week_start` - начало недели
- `total_amount` - всего заработано
- `paid_amount` - выплачено
- `pending_amount` - в ожидании

**salary_payments** - выплаты зарплат
- `id` - UUID
- `user_id` - ID пользователя
- `amount` - сумма
- `status` - статус (pending, paid, rejected)
- `rejection_reason` - причина отклонения

**transaction_history** - история транзакций
- `id` - UUID
- `user_id` - ID пользователя
- `transaction_type` - тип (earning, payment, refund)
- `amount` - сумма
- `description` - описание

### SQL функции

**get_tutor_payment_stats** - статистика выплат репетитора
**update_salary_payment_status** - обновление статуса выплаты
**cancel_lesson_earning** - отмена начисления за урок

## Установка и настройка

### 1. Запуск SQL скриптов

\`\`\`bash
# Основная система ролей
scripts/027_role_based_system.sql

# Исправления
scripts/028_fix_role_system.sql

# Система выплат
scripts/029_payment_tracking_system.sql
\`\`\`

### 2. Создание первого администратора

После регистрации первого пользователя, обновите его роль в БД:

\`\`\`sql
UPDATE profiles 
SET role = 'admin' 
WHERE email = 'your-email@example.com';
\`\`\`

### 3. Настройка ставок

ГА должен установить:
- Ставку для каждого репетитора (сколько получает за урок)
- Стоимость урока для клиентов

### 4. Создание пользователей

ГА создает пользователей через интерфейс:
- Репетиторы
- Менеджеры
- Ученики (через репетиторов или менеджеров)

## Типичные сценарии

### Сценарий 1: Новый ученик

1. Менеджер получает заявку от клиента
2. Менеджер создает ученика, назначает репетитора
3. Менеджер добавляет платеж (покупка уроков)
4. Менеджер прикрепляет чек к платежу
5. Репетитор создает регулярное расписание
6. Система автоматически создает уроки

### Сценарий 2: Проведение урока

1. Репетитор проводит урок
2. Репетитор отмечает урок как "completed"
3. Система автоматически:
   - Списывает 1 урок у ученика
   - Начисляет заработок репетитору
   - Создает запись в истории транзакций

### Сценарий 3: Выплата зарплаты

1. Конец недели - система создает записи в `salary_payments`
2. ГА видит запросы на выплату
3. ГА проверяет чеки и документы
4. ГА одобряет или отклоняет выплату
5. При одобрении - сумма добавляется в `paid_amount`
6. При отклонении - указывается причина, сумма обнуляется

### Сценарий 4: Изменение расписания

1. Репетитор открывает регулярное расписание
2. Репетитор меняет время (например, с 16:00 на 15:00)
3. Система автоматически:
   - Удаляет все будущие уроки по старому времени
   - Создает новые уроки по новому времени

## Безопасность

### Middleware

Файл `middleware.ts` проверяет роли и перенаправляет:
- `/admin` - только для admin
- `/tutor` - только для tutor
- `/manager` - только для manager
- `/student` - только для student

### RLS (Row Level Security)

Включен для всех таблиц:
- Репетиторы видят только своих учеников
- Менеджеры видят все платежи
- Ученики видят только свои данные
- ГА видит все

## Поддержка и развитие

### Возможные улучшения

- [ ] Уведомления о предстоящих уроках
- [ ] Интеграция с календарями (Google Calendar)
- [ ] Автоматические напоминания ученикам
- [ ] Система отзывов
- [ ] Мобильное приложение
- [ ] Видеозвонки внутри системы
- [ ] Чат между репетитором и учеником

### Известные ограничения

- Время для учеников жестко закодировано (-2 часа)
- Выплаты создаются вручную (нет автоматики)
- Нет интеграции с платежными системами

## Контакты

Для вопросов и поддержки обращайтесь к разработчику системы.
