# Система ролей CRM для репетиторов

## Обзор

Система поддерживает 4 роли пользователей:

1. **Главный Администратор (admin)** - полный доступ ко всей системе
2. **Репетитор (tutor)** - управление своими учениками и уроками
3. **Менеджер (manager)** - управление платежами и добавление уроков
4. **Ученик (student)** - просмотр своего расписания и статистики

## Настройка

### 1. Запустите SQL скрипты

Выполните следующие скрипты в указанном порядке:

\`\`\`bash
# Основная система ролей
scripts/027_role_based_system.sql

# Исправления и дополнения
scripts/028_fix_role_system.sql
\`\`\`

### 2. Создайте первого администратора

После запуска скриптов, создайте первого администратора через Supabase Dashboard:

1. Перейдите в Authentication → Users
2. Создайте нового пользователя с email и паролем
3. Скопируйте UUID созданного пользователя
4. Выполните SQL запрос:

\`\`\`sql
-- Обновите профиль пользователя на роль admin
UPDATE profiles 
SET role = 'admin', full_name = 'Главный Администратор'
WHERE id = 'UUID_ВАШЕГО_ПОЛЬЗОВАТЕЛЯ';
\`\`\`

### 3. Настройте переменные окружения

Убедитесь, что у вас есть все необходимые переменные окружения:

\`\`\`env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL=http://localhost:3000
\`\`\`

## Функционал по ролям

### Главный Администратор

**Доступ:** `/admin`

**Возможности:**
- Просмотр всех пользователей системы
- Добавление/удаление репетиторов и менеджеров
- Просмотр всех учеников (общий список и по репетиторам)
- Управление выплатами зарплат
- Настройка ставок репетиторов (сколько получают за урок)
- Настройка цен на уроки (сколько стоит для клиента)
- Статистика за месяц:
  - Общий доход
  - Чистая прибыль (доход - расходы на ЗП)
  - Количество проведенных уроков
  - Количество пользователей

**Расчет дохода:**
- Чистая прибыль = Доход от клиентов - ЗП репетиторов - ЗП менеджеров
- Отчеты за месяц

### Репетитор

**Доступ:** `/tutor`

**Возможности:**
- Просмотр своих учеников
- Добавление новых учеников
- Управление расписанием уроков
- Создание регулярных расписаний
- Выставление оценок за уроки
- Добавление домашних заданий
- Просмотр своего заработка за неделю
- Статистика по своим урокам

**Расчет заработка:**
- За каждый проведенный урок (статус "completed") автоматически начисляется сумма, установленная администратором
- ЗП выплачивается раз в неделю
- Репетитор видит свой заработок за текущую неделю

### Менеджер

**Доступ:** `/manager`

**Возможности:**
- Просмотр всех учеников
- Добавление платежей от клиентов
- Прикрепление чеков к платежам
- Добавление уроков ученикам
- Просмотр своего заработка за неделю
- Статистика по продажам

**Расчет заработка:**
- Базовая ставка: 500₽ в неделю
- Комиссия: 5% от всех продаж за неделю
- Итого: 500₽ + 5% от продаж
- ЗП выплачивается раз в неделю

### Ученик

**Доступ:** `/student`

**Возможности:**
- Просмотр своего расписания
- Просмотр оставшихся уроков
- Просмотр истории уроков с оценками
- Просмотр домашних заданий
- Доступ к ссылкам на уроки
- Статистика обучения (графики, средняя оценка)
- Информация о своем преподавателе

**Особенности:**
- При первом входе ученик устанавливает свой никнейм
- Никнейм виден только ученику (репетитор видит реальное имя)
- Время уроков показывается с учетом часового пояса (фактическое время - 2 часа)

## Создание пользователей

### Создание репетитора/менеджера (через админ панель)

1. Войдите как администратор
2. Перейдите на вкладку "Пользователи"
3. Нажмите "Добавить пользователя"
4. Заполните форму:
   - Email
   - Полное имя
   - Роль (Репетитор или Менеджер)
   - Для репетитора: ставка за урок и цена урока
5. Система автоматически создаст аккаунт и отправит данные для входа

### Создание ученика

Ученика может создать:
- Администратор (выбирает репетитора из списка)
- Репетитор (автоматически привязывается к себе)
- Менеджер (выбирает репетитора из списка)

При создании ученика:
1. Заполните основную информацию (имя, email, телефон)
2. Укажите ссылку на урок (будет использоваться для всех уроков)
3. Включите "Создать учетную запись" для автоматической генерации логина/пароля
4. Система создаст аккаунт и покажет данные для входа

## Управление уроками

### Добавление уроков

**Разовый урок:**
1. Выберите ученика
2. Нажмите "Добавить урок"
3. Укажите дату, время, длительность
4. Урок будет создан

**Регулярное расписание:**
1. Выберите ученика
2. Нажмите "Регулярное расписание"
3. Выберите дни недели и время
4. Укажите период (с какой по какую дату)
5. Система автоматически создаст все уроки

### Изменение регулярного расписания

1. Перейдите в "Календарь" → "Регулярные расписания"
2. Найдите нужного ученика
3. Нажмите "Управление"
4. Измените время или дни недели
5. Все будущие уроки автоматически обновятся

### Проведение урока

1. Откройте детали урока
2. Нажмите "Проведено" или измените статус на "Проведен"
3. Выставьте оценку (опционально)
4. Добавьте домашнее задание (опционально)
5. Система автоматически:
   - Спишет урок у ученика
   - Начислит заработок репетитору

## Управление платежами

### Добавление платежа (менеджер/админ)

1. Перейдите в раздел "Платежи"
2. Нажмите "Добавить платеж"
3. Выберите ученика
4. Укажите сумму и количество уроков
5. Прикрепите чек (опционально)
6. Система автоматически:
   - Добавит уроки ученику
   - Зафиксирует продажу для расчета комиссии менеджера

### Выплата зарплат (админ)

1. Перейдите на вкладку "Зарплаты"
2. Просмотрите список невыплаченных зарплат
3. Нажмите "Выплатить" для каждой зарплаты
4. Система отметит зарплату как выплаченную

## Безопасность

### Row Level Security (RLS)

Все таблицы защищены политиками RLS:

- **Репетиторы** видят только своих учеников и уроки
- **Менеджеры** видят всех учеников и могут добавлять платежи
- **Ученики** видят только свои данные
- **Администраторы** видят все данные

### Аутентификация

- Используется Supabase Auth
- Ученики входят по логину/паролю (формат: `login@student.tutorcrm.local`)
- Репетиторы и менеджеры входят по email/паролю
- Middleware автоматически перенаправляет на соответствующий дашборд

## Troubleshooting

### Ученик не может войти

1. Проверьте, что учетная запись была создана (в деталях ученика должны быть логин/пароль)
2. Убедитесь, что ученик использует правильный логин и пароль
3. Проверьте, что в Supabase Auth создан пользователь с email `login@student.tutorcrm.local`

### Не начисляется заработок репетитору

1. Проверьте, что у репетитора установлена ставка за урок (в настройках репетитора)
2. Убедитесь, что урок имеет статус "completed"
3. Проверьте, что урок привязан к репетитору (поле `tutor_id`)

### Не рассчитывается комиссия менеджера

1. Проверьте, что платеж привязан к менеджеру (поле `manager_id`)
2. Убедитесь, что платеж был создан в текущей неделе
3. Проверьте таблицу `manager_sales`

## Поддержка

Для получения помощи обратитесь к документации Supabase или создайте issue в репозитории проекта.
